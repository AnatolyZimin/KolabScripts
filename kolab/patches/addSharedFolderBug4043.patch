From bcc0fcdf573fb1476eb31f5b900c9e047eb1649d Mon Sep 17 00:00:00 2001
From: Timotheus Pokorra <tp@tbits.net>
Date: Mon, 8 Dec 2014 13:48:19 +0100
Subject: [PATCH] ldap add sharedfolder, role, and user: use optional attribute ou to calculate the base_dn.
 same code as for group, organizationalunit and resource

---
 lib/Auth/LDAP.php |   20 ++++++++++++++++----
 1 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/lib/Auth/LDAP.php b/lib/Auth/LDAP.php
index 7a61524..968d943 100644
--- a/lib/Auth/LDAP.php
+++ b/lib/Auth/LDAP.php
@@ -839,7 +839,13 @@ class LDAP extends Net_LDAP3 {
 
     public function role_add($attrs, $typeid = null)
     {
-        $base_dn = $this->entry_base_dn('role', $typeid);
+        if (!empty($attrs['ou'])) {
+            $base_dn = $attrs['ou'];
+            unset($attrs['ou']);
+        }
+        else {
+            $base_dn = $this->entry_base_dn('role', $typeid);
+        }
 
         // TODO: The rdn is configurable as well.
         // Use [$type_str . "_"]role_rdn_attr
@@ -891,7 +897,13 @@ class LDAP extends Net_LDAP3 {
 
     public function sharedfolder_add($attrs, $typeid = null)
     {
-        $base_dn = $this->entry_base_dn('sharedfolder', $typeid);
+        if (!empty($attrs['ou'])) {
+            $base_dn = $attrs['ou'];
+            unset($attrs['ou']);
+        }
+        else {
+            $base_dn = $this->entry_base_dn('sharedfolder', $typeid);
+        }
 
         // TODO: The rdn is configurable as well.
         // Use [$type_str . "_"]user_rdn_attr
@@ -958,11 +970,11 @@ class LDAP extends Net_LDAP3 {
 
     public function user_add($attrs, $typeid = null)
     {
-        $base_dn = $this->entry_base_dn('user', $typeid);
-
         if (!empty($attrs['ou'])) {
             $base_dn = $attrs['ou'];
             unset($attrs['ou']);
+        } else {
+            $base_dn = $this->entry_base_dn('user', $typeid);
         }
 
         // TODO: The rdn is configurable as well.
-- 
1.7.1
